# TapDash Email Swarm Master Plan
Last updated: 2026-02-17
Status: Active canonical plan (single source of truth)

## Purpose
This document is the implementation plan for the intelligent TapDash email swarm.
All roadmap, architecture, and delivery decisions should align to this file.

## Current Baseline (already running)
- Platform: Railway project `industrious-youth`, service `pipeline`.
- Ingress: `POST /zapier/email-forward` on the intake service.
- Processing: intake filter, work-order creation, policy tiering, draft pipeline, publish sender.
- Persistence: JSONL files on attached volume `/data`.
- Outbound: Zapier webhook publish flow with metadata passthrough (`message_id`, `conversation_id`, sender/recipient fields, `send` flag).
- Keep-alive: scheduled ping via `.github/workflows/ping-railway.yml`.

## Problem Statement
Current drafts are template based and not intelligent. The system must produce context-aware replies with agentic reasoning, enforce policy gates, and preserve thread-aware metadata for in-thread drafting/sending.

## Target State (what we are building)
- LLM-generated drafts, not canned templates.
- Multi-stage agent flow:
  - Intake
  - Context assembly (thread + CRM + precedent)
  - Draft generation
  - Tone/style QA
  - Fact/risk gate
  - Publish or escalate
- Durable state in Postgres (not file-only JSONL).
- Human escalation surface for low-confidence or policy-sensitive replies.

## Architecture Plan
## 1. Orchestration
- Commander pipeline controls lifecycle and observability per work order.
- Worker stages communicate through explicit events/states.
- Every stage appends provenance and confidence fields.

## 2. Data Model
- Core entities:
  - `work_orders`
  - `context_packs`
  - `drafts`
  - `qa_results`
  - `escalations`
  - `publish_queue`
  - `precedents`
- Required metadata in all downstream records:
  - `work_order_id`
  - `message_id`
  - `conversation_id`
  - `from_addr`
  - `to_addrs`
  - `cc_addrs`
  - `subject`

## 3. Integrations
- Outlook/Graph:
  - Fetch thread context using `message_id` and/or `conversation_id`.
  - Publish as draft or send in existing thread.
- Monday:
  - Enrich by sender email/domain (board `18397429943`).
- Zapier:
  - Continue as fallback publish path until Graph send is fully enabled.

## 4. LLM Drafting Spec
- Default model: `gpt-4.1-mini` (configurable).
- Prompt inputs:
  - thread context
  - sender/recipient info
  - subject/body
  - Monday enrichment
  - approved tone constraints
- Output contract:
  - `draft_subject`
  - `draft_body`
  - `confidence`
  - `rationale`
  - `citations`
- Tone constraints:
  - professional
  - concise
  - friendly undertone
  - no em dashes
  - clear CTA

## Delivery Plan (phased)
## Phase 1: Intelligent Drafting
- Replace canned text path in `pipeline_daemon.py` with OpenAI call.
- Add structured validation of model output.
- Gate auto-send by confidence and policy tier.
- Exit criteria:
  - drafts are LLM-generated
  - metadata passthrough remains intact
  - low-confidence outputs escalate

## Phase 2: Durable State
- Move pipeline state from JSONL to Postgres tables.
- Keep JSONL optional for local debugging only.
- Exit criteria:
  - end-to-end flow survives restart without state loss
  - workers can scale without shared-volume coupling

## Phase 3: Context Enrichment
- Add Graph thread retrieval and Monday enrichment into context pack.
- Persist enrichment and citations in provenance.
- Exit criteria:
  - draft quality clearly uses thread + CRM facts
  - publish payload carries full thread metadata

## Phase 4: Agentic Decomposition
- Split monolithic daemon into workers (intake/context/draft/qa/publish).
- Add queue/event-driven handoff.
- Exit criteria:
  - independent worker retries
  - per-stage monitoring and backlog visibility

## Phase 5: Human Review Surface
- Add minimal escalation endpoint/view for approve/edit/reject.
- Feed approved edits into precedent memory.
- Exit criteria:
  - human reviewers can resolve escalations quickly
  - precedents reduce repeated escalations

## Immediate Priorities
- Implement Phase 1 first (intelligent drafts).
- Keep Zapier publish path stable while upgrading internals.
- Do not expand deployment topology until Phase 2 is complete.

## Dependencies and Required Secrets
- `OPENAI_API_KEY`
- `ZAPIER_SHARED_SECRET`
- `PUBLISH_WEBHOOK_URL`
- `MONDAY_API_TOKEN`
- Optional for Graph path:
  - `GRAPH_TENANT_ID`
  - `GRAPH_CLIENT_ID`
  - `GRAPH_CLIENT_SECRET`

## Acceptance Criteria for "Intelligent Replies"
- Drafts are generated by LLM with defined tone constraints.
- Work-order context includes thread metadata and enrichment when available.
- Unsafe/uncertain drafts do not auto-send and are escalated.
- Publish payloads remain thread-aware for in-thread response creation.
- Plan status can be tracked directly from this document and linked references.
